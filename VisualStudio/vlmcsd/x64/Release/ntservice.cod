; Listing generated by Microsoft (R) Optimizing Compiler Version 18.00.40629.0 

include listing.inc

INCLUDELIB OLDNAMES

PUBLIC	??_C@_03HLHKOPNL@KMS?$AA@			; `string'
PUBLIC	??_C@_01BJJEKLCA@?$CC?$AA@			; `string'
PUBLIC	??_C@_0BD@FKPFFKIB@?N?$NO?$LH?$KI?$LA?$LC?W?$LA?$LH?$PO?N?q?5?$CI?$CFd?$CJ?6?$AA@ ; `string'
PUBLIC	??_C@_02DEDJNJGL@?9s?$AA@			; `string'
PUBLIC	??_C@_02MFNBDIMN@?9W?$AA@			; `string'
PUBLIC	??_C@_02PHOHFKEP@?9U?$AA@			; `string'
PUBLIC	??_C@_01CLKCMJKC@?5?$AA@			; `string'
PUBLIC	??_C@_0BD@KBOGNFMA@?$LH?$PO?N?q?I?$LO?$LD?$PN?J?$KH?$LA?$NM?5?$CI?$CFd?$CJ?6?$AA@ ; `string'
PUBLIC	??_C@_02PKOHADJL@?1l?$AA@			; `string'
PUBLIC	??_C@_0BK@PHAGCFFB@NT?5AUTHORITY?2LocalService?$AA@ ; `string'
PUBLIC	??_C@_02MINBGBBJ@?1n?$AA@			; `string'
PUBLIC	??_C@_0BM@PDMNECKP@NT?5AUTHORITY?2NetworkService?$AA@ ; `string'
PUBLIC	??_C@_02CEGDFPFP@?4?2?$AA@			; `string'
PUBLIC	??_C@_06BPNJJJFL@tcpip?$AA?$AA@			; `string'
PUBLIC	??_C@_0BE@PCJAAINM@KeyManagementServer?$AA@	; `string'
PUBLIC	??_C@_0BD@DCFFOBGC@?$LE?$LE?$LN?$KI?$LH?$PO?N?q?J?$KH?$LA?$NM?5?$CI?$CFu?$CJ?6?$AA@ ; `string'
PUBLIC	??_C@_0O@IJHOBBJB@?$LH?$PO?N?q?$LA?$LC?W?$LA?$LD?I?$LJ?$KG?6?$AA@ ; `string'
PUBLIC	??_C@_0BG@MFFHEMO@?V?X?P?B?F?t?$LG?$KP?5KMS?5?$LH?$PO?N?q?5?$DN?$DO?5?$AA@ ; `string'
PUBLIC	??_C@_05HBAGHNGF@?$LD?I?$LJ?$KG?6?$AA@		; `string'
PUBLIC	??_C@_0BL@MMELEJAD@Not?5ready?5within?5a?5second?6?$AA@ ; `string'
PUBLIC	??_C@_06HPIHNGNL@Error?6?$AA@			; `string'
PUBLIC	??_C@_09JBCKIECM@Error?5?$CFu?6?$AA@		; `string'
PUBLIC	??_C@_0BD@HFJNIJEE@?$LE?m?N?s?5?I?$LO?$LD?$PN?$LH?$PO?N?q?4?5?$CFs?6?$AA@ ; `string'
PUBLIC	??_C@_0BD@DBLMEHIF@?$LH?$PO?N?q?5?$CFs?5?$LD?I?$LJ?$KG?R?F?$LD?$PN?4?6?$AA@ ; `string'
PUBLIC	??_C@_0BA@NOKEGPBL@?$LH?$PO?N?q?5?$CFs?$LC?$LL?$LE?f?T?Z?4?6?$AA@ ; `string'
PUBLIC	NTServiceDispatchTable
EXTRN	__imp_ControlService:PROC
EXTRN	__imp_OpenSCManagerA:PROC
EXTRN	__imp_SetServiceStatus:PROC
EXTRN	__imp_QueryServiceStatus:PROC
EXTRN	__imp_StartServiceA:PROC
EXTRN	__imp_Sleep:PROC
EXTRN	__imp_CreateServiceA:PROC
EXTRN	__imp_RegisterServiceCtrlHandlerA:PROC
EXTRN	__imp_DeleteService:PROC
EXTRN	__imp_CloseServiceHandle:PROC
EXTRN	__imp_OpenServiceA:PROC
COMM	gSvcStatus:BYTE:01cH
COMM	gSvcStatusHandle:QWORD
_DATA	ENDS
;	COMDAT ??_C@_0BA@NOKEGPBL@?$LH?$PO?N?q?5?$CFs?$LC?$LL?$LE?f?T?Z?4?6?$AA@
CONST	SEGMENT
??_C@_0BA@NOKEGPBL@?$LH?$PO?N?q?5?$CFs?$LC?$LL?$LE?f?T?Z?4?6?$AA@ DB 0b7H
	DB	0feH, 0ceH, 0f1H, ' %s', 0b2H, 0bbH, 0b4H, 0e6H, 0d4H, 0daH, '.'
	DB	0aH, 00H					; `string'
CONST	ENDS
;	COMDAT ??_C@_0BD@DBLMEHIF@?$LH?$PO?N?q?5?$CFs?5?$LD?I?$LJ?$KG?R?F?$LD?$PN?4?6?$AA@
CONST	SEGMENT
??_C@_0BD@DBLMEHIF@?$LH?$PO?N?q?5?$CFs?5?$LD?I?$LJ?$KG?R?F?$LD?$PN?4?6?$AA@ DB 0b7H
	DB	0feH, 0ceH, 0f1H, ' %s ', 0b3H, 0c9H, 0b9H, 0a6H, 0d2H, 0c6H, 0b3H
	DB	0fdH, '.', 0aH, 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0BD@HFJNIJEE@?$LE?m?N?s?5?I?$LO?$LD?$PN?$LH?$PO?N?q?4?5?$CFs?6?$AA@
CONST	SEGMENT
??_C@_0BD@HFJNIJEE@?$LE?m?N?s?5?I?$LO?$LD?$PN?$LH?$PO?N?q?4?5?$CFs?6?$AA@ DB 0b4H
	DB	0edH, 0ceH, 0f3H, ' ', 0c9H, 0beH, 0b3H, 0fdH, 0b7H, 0feH, 0ceH
	DB	0f1H, '. %s', 0aH, 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_09JBCKIECM@Error?5?$CFu?6?$AA@
CONST	SEGMENT
??_C@_09JBCKIECM@Error?5?$CFu?6?$AA@ DB 'Error %u', 0aH, 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_06HPIHNGNL@Error?6?$AA@
CONST	SEGMENT
??_C@_06HPIHNGNL@Error?6?$AA@ DB 'Error', 0aH, 00H	; `string'
CONST	ENDS
;	COMDAT ??_C@_0BL@MMELEJAD@Not?5ready?5within?5a?5second?6?$AA@
CONST	SEGMENT
??_C@_0BL@MMELEJAD@Not?5ready?5within?5a?5second?6?$AA@ DB 'Not ready wit'
	DB	'hin a second', 0aH, 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_05HBAGHNGF@?$LD?I?$LJ?$KG?6?$AA@
CONST	SEGMENT
??_C@_05HBAGHNGF@?$LD?I?$LJ?$KG?6?$AA@ DB 0b3H, 0c9H, 0b9H, 0a6H, 0aH, 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0BG@MFFHEMO@?V?X?P?B?F?t?$LG?$KP?5KMS?5?$LH?$PO?N?q?5?$DN?$DO?5?$AA@
CONST	SEGMENT
??_C@_0BG@MFFHEMO@?V?X?P?B?F?t?$LG?$KP?5KMS?5?$LH?$PO?N?q?5?$DN?$DO?5?$AA@ DB 0d6H
	DB	0d8H, 0d0H, 0c2H, 0c6H, 0f4H, 0b6H, 0afH, ' KMS ', 0b7H, 0feH, 0ceH
	DB	0f1H, ' => ', 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0O@IJHOBBJB@?$LH?$PO?N?q?$LA?$LC?W?$LA?$LD?I?$LJ?$KG?6?$AA@
CONST	SEGMENT
??_C@_0O@IJHOBBJB@?$LH?$PO?N?q?$LA?$LC?W?$LA?$LD?I?$LJ?$KG?6?$AA@ DB 0b7H
	DB	0feH, 0ceH, 0f1H, 0b0H, 0b2H, 0d7H, 0b0H, 0b3H, 0c9H, 0b9H, 0a6H
	DB	0aH, 00H					; `string'
CONST	ENDS
;	COMDAT ??_C@_0BD@DCFFOBGC@?$LE?$LE?$LN?$KI?$LH?$PO?N?q?J?$KH?$LA?$NM?5?$CI?$CFu?$CJ?6?$AA@
CONST	SEGMENT
??_C@_0BD@DCFFOBGC@?$LE?$LE?$LN?$KI?$LH?$PO?N?q?J?$KH?$LA?$NM?5?$CI?$CFu?$CJ?6?$AA@ DB 0b4H
	DB	0b4H, 0bdH, 0a8H, 0b7H, 0feH, 0ceH, 0f1H, 0caH, 0a7H, 0b0H, 0dcH
	DB	' (%u)', 0aH, 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0BE@PCJAAINM@KeyManagementServer?$AA@
CONST	SEGMENT
??_C@_0BE@PCJAAINM@KeyManagementServer?$AA@ DB 'KeyManagementServer', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_06BPNJJJFL@tcpip?$AA?$AA@
CONST	SEGMENT
??_C@_06BPNJJJFL@tcpip?$AA?$AA@ DB 'tcpip', 00H, 00H	; `string'
CONST	ENDS
;	COMDAT ??_C@_02CEGDFPFP@?4?2?$AA@
CONST	SEGMENT
??_C@_02CEGDFPFP@?4?2?$AA@ DB '.\', 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_0BM@PDMNECKP@NT?5AUTHORITY?2NetworkService?$AA@
CONST	SEGMENT
??_C@_0BM@PDMNECKP@NT?5AUTHORITY?2NetworkService?$AA@ DB 'NT AUTHORITY\Ne'
	DB	'tworkService', 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_02MINBGBBJ@?1n?$AA@
CONST	SEGMENT
??_C@_02MINBGBBJ@?1n?$AA@ DB '/n', 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_0BK@PHAGCFFB@NT?5AUTHORITY?2LocalService?$AA@
CONST	SEGMENT
??_C@_0BK@PHAGCFFB@NT?5AUTHORITY?2LocalService?$AA@ DB 'NT AUTHORITY\Loca'
	DB	'lService', 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_02PKOHADJL@?1l?$AA@
CONST	SEGMENT
??_C@_02PKOHADJL@?1l?$AA@ DB '/l', 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_0BD@KBOGNFMA@?$LH?$PO?N?q?I?$LO?$LD?$PN?J?$KH?$LA?$NM?5?$CI?$CFd?$CJ?6?$AA@
CONST	SEGMENT
??_C@_0BD@KBOGNFMA@?$LH?$PO?N?q?I?$LO?$LD?$PN?J?$KH?$LA?$NM?5?$CI?$CFd?$CJ?6?$AA@ DB 0b7H
	DB	0feH, 0ceH, 0f1H, 0c9H, 0beH, 0b3H, 0fdH, 0caH, 0a7H, 0b0H, 0dcH
	DB	' (%d)', 0aH, 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_01CLKCMJKC@?5?$AA@
CONST	SEGMENT
??_C@_01CLKCMJKC@?5?$AA@ DB ' ', 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_02PHOHFKEP@?9U?$AA@
CONST	SEGMENT
??_C@_02PHOHFKEP@?9U?$AA@ DB '-U', 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_02MFNBDIMN@?9W?$AA@
CONST	SEGMENT
??_C@_02MFNBDIMN@?9W?$AA@ DB '-W', 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_02DEDJNJGL@?9s?$AA@
CONST	SEGMENT
??_C@_02DEDJNJGL@?9s?$AA@ DB '-s', 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_0BD@FKPFFKIB@?N?$NO?$LH?$KI?$LA?$LC?W?$LA?$LH?$PO?N?q?5?$CI?$CFd?$CJ?6?$AA@
CONST	SEGMENT
??_C@_0BD@FKPFFKIB@?N?$NO?$LH?$KI?$LA?$LC?W?$LA?$LH?$PO?N?q?5?$CI?$CFd?$CJ?6?$AA@ DB 0ceH
	DB	0deH, 0b7H, 0a8H, 0b0H, 0b2H, 0d7H, 0b0H, 0b7H, 0feH, 0ceH, 0f1H
	DB	' (%d)', 0aH, 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_01BJJEKLCA@?$CC?$AA@
CONST	SEGMENT
??_C@_01BJJEKLCA@?$CC?$AA@ DB '"', 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_03HLHKOPNL@KMS?$AA@
CONST	SEGMENT
??_C@_03HLHKOPNL@KMS?$AA@ DB 'KMS', 00H			; `string'
?dwCheckPoint@?1??ReportServiceStatus@@9@9 DD 01H	; `ReportServiceStatus'::`2'::dwCheckPoint
NTServiceDispatchTable DQ FLAT:??_C@_03HLHKOPNL@KMS?$AA@
	DQ	FLAT:ServiceMain
	DQ	0000000000000000H
	DQ	0000000000000000H
PUBLIC	NtServiceInstallation
PUBLIC	ReportServiceStatus
PUBLIC	ServiceCtrlHandler
PUBLIC	RtlSecureZeroMemory
;	COMDAT pdata
pdata	SEGMENT
$pdata$NtServiceInstallation DD imagerel $LN13
	DD	imagerel $LN13+130
	DD	imagerel $unwind$NtServiceInstallation
pdata	ENDS
;	COMDAT pdata
pdata	SEGMENT
$pdata$ServiceInstaller DD imagerel ServiceInstaller
	DD	imagerel ServiceInstaller+1073
	DD	imagerel $unwind$ServiceInstaller
pdata	ENDS
;	COMDAT pdata
pdata	SEGMENT
$pdata$OpenAndRemoveService DD imagerel OpenAndRemoveService
	DD	imagerel OpenAndRemoveService+290
	DD	imagerel $unwind$OpenAndRemoveService
pdata	ENDS
;	COMDAT pdata
pdata	SEGMENT
$pdata$ServiceMain DD imagerel ServiceMain
	DD	imagerel ServiceMain+123
	DD	imagerel $unwind$ServiceMain
pdata	ENDS
;	COMDAT pdata
pdata	SEGMENT
$pdata$ServiceCtrlHandler DD imagerel $LN8
	DD	imagerel $LN8+43
	DD	imagerel $unwind$ServiceCtrlHandler
pdata	ENDS
;	COMDAT pdata
pdata	SEGMENT
$pdata$RtlSecureZeroMemory DD imagerel $LN4
	DD	imagerel $LN4+27
	DD	imagerel $unwind$RtlSecureZeroMemory
;	COMDAT xdata
xdata	SEGMENT
$unwind$RtlSecureZeroMemory DD 020501H
	DD	017405H
xdata	ENDS
;	COMDAT xdata
xdata	SEGMENT
$unwind$ServiceCtrlHandler DD 010401H
	DD	04204H
xdata	ENDS
;	COMDAT xdata
xdata	SEGMENT
$unwind$ServiceMain DD 010401H
	DD	04204H
xdata	ENDS
;	COMDAT xdata
xdata	SEGMENT
$unwind$OpenAndRemoveService DD 0250b1b01H
	DD	0de41bH
	DD	0c7417H
	DD	0b6413H
	DD	0a340fH
	DD	07206230bH
	DD	05002H
xdata	ENDS
;	COMDAT xdata
xdata	SEGMENT
$unwind$ServiceInstaller DD 0b1f01H
	DD	03c341fH
	DD	034011fH
	DD	0e00ef010H
	DD	0c00ad00cH
	DD	060077008H
	DD	05006H
xdata	ENDS
;	COMDAT xdata
xdata	SEGMENT
$unwind$NtServiceInstallation DD 010401H
	DD	04204H
; Function compile flags: /Ogspy
; File c:\program files (x86)\microsoft sdks\windows\v7.1a\include\winnt.h
;	COMDAT RtlSecureZeroMemory
_TEXT	SEGMENT
ptr$ = 8
cnt$ = 16
RtlSecureZeroMemory PROC				; COMDAT

; 13069: {

$LN4:
  00000	48 89 7c 24 08	 mov	 QWORD PTR [rsp+8], rdi
  00005	4c 8b c1	 mov	 r8, rcx

; 13070:     volatile char *vptr = (volatile char *)ptr;
; 13071: 
; 13072: #if defined(_M_AMD64)
; 13073: 
; 13074:         __stosb((PBYTE )((DWORD64)vptr), 0, cnt);

  00008	48 8b f9	 mov	 rdi, rcx
  0000b	33 c0		 xor	 eax, eax
  0000d	48 8b ca	 mov	 rcx, rdx
  00010	f3 aa		 rep stosb

; 13075: 
; 13076: #else
; 13077: 
; 13078:     while (cnt) {
; 13079:         *vptr = 0;
; 13080:         vptr++;
; 13081:         cnt--;
; 13082:     }
; 13083: 
; 13084: #endif
; 13085: 
; 13086:     return ptr;
; 13087: }

  00012	48 8b 7c 24 08	 mov	 rdi, QWORD PTR [rsp+8]
  00017	49 8b c0	 mov	 rax, r8
  0001a	c3		 ret	 0
RtlSecureZeroMemory ENDP
_TEXT	ENDS
; Function compile flags: /Ogspy
; File c:\users\apple\desktop\vlmcsd\src\ntservice.c
;	COMDAT ServiceCtrlHandler
_TEXT	SEGMENT
dwCtrl$ = 48
ServiceCtrlHandler PROC					; COMDAT

; 18   : {

$LN8:
  00000	48 83 ec 28	 sub	 rsp, 40			; 00000028H

; 19   : 	// Handle the requested control code.
; 20   : 	switch (dwCtrl)

  00004	ff c9		 dec	 ecx
  00006	74 05		 je	 SHORT $LN2@ServiceCtr
  00008	83 f9 04	 cmp	 ecx, 4
  0000b	75 19		 jne	 SHORT $LN1@ServiceCtr
$LN2@ServiceCtr:

; 21   : 	{
; 22   : 	case SERVICE_CONTROL_STOP:
; 23   : 	case SERVICE_CONTROL_SHUTDOWN:
; 24   : 
; 25   : 		ServiceShutdown = TRUE;
; 26   : 		ReportServiceStatus(SERVICE_STOP_PENDING, NO_ERROR, 0);

  0000d	33 d2		 xor	 edx, edx
  0000f	45 33 c0	 xor	 r8d, r8d
  00012	c6 05 00 00 00
	00 01		 mov	 BYTE PTR ServiceShutdown, 1
  00019	8d 4a 03	 lea	 ecx, QWORD PTR [rdx+3]
  0001c	e8 00 00 00 00	 call	 ReportServiceStatus

; 27   : 
; 28   : 		// Remove PID file and free ressources
; 29   : 		cleanup();

  00021	e8 00 00 00 00	 call	 cleanup
$LN1@ServiceCtr:

; 30   : #			if __CYGWIN__ || defined(USE_MSRPC)
; 31   : 		ReportServiceStatus(SERVICE_STOPPED, NO_ERROR, 0);
; 32   : #			endif // __CYGWIN__
; 33   : 
; 34   : 	default:
; 35   : 		break;
; 36   : 	}
; 37   : }

  00026	48 83 c4 28	 add	 rsp, 40			; 00000028H
  0002a	c3		 ret	 0
ServiceCtrlHandler ENDP
_TEXT	ENDS
; Function compile flags: /Ogspy
; File c:\users\apple\desktop\vlmcsd\src\ntservice.c
;	COMDAT ServiceMain
_TEXT	SEGMENT
argc_unused$ = 48
argv_unused$ = 56
ServiceMain PROC					; COMDAT

; 40   : {

  00000	48 83 ec 28	 sub	 rsp, 40			; 00000028H

; 41   : 	// Register the handler function for the service
; 42   : 	//注册该服务的处理函数
; 43   : 	if (!((gSvcStatusHandle = RegisterServiceCtrlHandler(NT_SERVICE_NAME, ServiceCtrlHandler))))

  00004	48 8d 15 00 00
	00 00		 lea	 rdx, OFFSET FLAT:ServiceCtrlHandler
  0000b	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_03HLHKOPNL@KMS?$AA@
  00012	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_RegisterServiceCtrlHandlerA
  00018	48 89 05 00 00
	00 00		 mov	 QWORD PTR gSvcStatusHandle, rax
  0001f	48 85 c0	 test	 rax, rax
  00022	74 52		 je	 SHORT $LN9@ServiceMai

; 44   : 	{
; 45   : 		return;
; 46   : 	}
; 47   : 
; 48   : 	// These SERVICE_STATUS members remain as set here
; 49   : 	//这些SERVICE_STATUS成员保持不变
; 50   : 	gSvcStatus.dwServiceType = SERVICE_WIN32_OWN_PROCESS;
; 51   : 	gSvcStatus.dwServiceSpecificExitCode = 0;

  00024	83 25 10 00 00
	00 00		 and	 DWORD PTR gSvcStatus+16, 0
  0002b	c7 05 00 00 00
	00 10 00 00 00	 mov	 DWORD PTR gSvcStatus, 16

; 52   : 
; 53   : 	// Run the actual program
; 54   : 	//运行实际的程序
; 55   : 	ReportServiceStatus(SERVICE_STOPPED, newmain(), 3000);

  00035	e8 00 00 00 00	 call	 newmain
  0003a	83 25 14 00 00
	00 00		 and	 DWORD PTR gSvcStatus+20, 0
  00041	b9 01 00 00 00	 mov	 ecx, 1
  00046	48 8d 15 00 00
	00 00		 lea	 rdx, OFFSET FLAT:gSvcStatus
  0004d	89 0d 04 00 00
	00		 mov	 DWORD PTR gSvcStatus+4, ecx
  00053	89 0d 08 00 00
	00		 mov	 DWORD PTR gSvcStatus+8, ecx
  00059	48 8b 0d 00 00
	00 00		 mov	 rcx, QWORD PTR gSvcStatusHandle
  00060	89 05 0c 00 00
	00		 mov	 DWORD PTR gSvcStatus+12, eax
  00066	c7 05 18 00 00
	00 b8 0b 00 00	 mov	 DWORD PTR gSvcStatus+24, 3000 ; 00000bb8H
  00070	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_SetServiceStatus
$LN9@ServiceMai:

; 56   : }

  00076	48 83 c4 28	 add	 rsp, 40			; 00000028H
  0007a	c3		 ret	 0
ServiceMain ENDP
_TEXT	ENDS
; Function compile flags: /Ogspy
; File c:\users\apple\desktop\vlmcsd\src\ntservice.c
;	COMDAT ReportServiceStatus
_TEXT	SEGMENT
dwCurrentState$ = 8
dwWin32ExitCode$ = 16
dwWaitHint$ = 24
ReportServiceStatus PROC				; COMDAT

; 71   : 	static DWORD dwCheckPoint = 1;
; 72   : 
; 73   : 	// Fill in the SERVICE_STATUS structure.
; 74   : 	//填写SERVICE_STATUS结构
; 75   : 	gSvcStatus.dwCurrentState = dwCurrentState;

  00000	89 0d 04 00 00
	00		 mov	 DWORD PTR gSvcStatus+4, ecx

; 76   : 	gSvcStatus.dwWin32ExitCode = dwWin32ExitCode;

  00006	89 15 0c 00 00
	00		 mov	 DWORD PTR gSvcStatus+12, edx

; 77   : 	gSvcStatus.dwWaitHint = dwWaitHint;

  0000c	44 89 05 18 00
	00 00		 mov	 DWORD PTR gSvcStatus+24, r8d

; 78   : 
; 79   : 	if (dwCurrentState == SERVICE_START_PENDING)
; 80   : 		gSvcStatus.dwControlsAccepted = 0;
; 81   : 	else
; 82   : 		gSvcStatus.dwControlsAccepted = SERVICE_ACCEPT_STOP;

  00013	c7 05 08 00 00
	00 01 00 00 00	 mov	 DWORD PTR gSvcStatus+8, 1

; 83   : 
; 84   : 	if ((dwCurrentState == SERVICE_RUNNING) ||
; 85   : 		(dwCurrentState == SERVICE_STOPPED))

  0001d	83 f9 04	 cmp	 ecx, 4
  00020	74 1b		 je	 SHORT $LN2@ReportServ
  00022	83 f9 01	 cmp	 ecx, 1
  00025	74 16		 je	 SHORT $LN2@ReportServ

; 87   : 	else
; 88   : 		gSvcStatus.dwCheckPoint = dwCheckPoint++;

  00027	8b 05 00 00 00
	00		 mov	 eax, DWORD PTR ?dwCheckPoint@?1??ReportServiceStatus@@9@9
  0002d	89 05 14 00 00
	00		 mov	 DWORD PTR gSvcStatus+20, eax
  00033	ff c0		 inc	 eax
  00035	89 05 00 00 00
	00		 mov	 DWORD PTR ?dwCheckPoint@?1??ReportServiceStatus@@9@9, eax
  0003b	eb 07		 jmp	 SHORT $LN1@ReportServ
$LN2@ReportServ:

; 86   : 		gSvcStatus.dwCheckPoint = 0;

  0003d	83 25 14 00 00
	00 00		 and	 DWORD PTR gSvcStatus+20, 0
$LN1@ReportServ:

; 89   : 
; 90   : 	// Report the status of the service to the SCM.
; 91   : 	SetServiceStatus(gSvcStatusHandle, &gSvcStatus);

  00044	48 8b 0d 00 00
	00 00		 mov	 rcx, QWORD PTR gSvcStatusHandle
  0004b	48 8d 15 00 00
	00 00		 lea	 rdx, OFFSET FLAT:gSvcStatus
  00052	48 ff 25 00 00
	00 00		 rex_jmp QWORD PTR __imp_SetServiceStatus
ReportServiceStatus ENDP
_TEXT	ENDS
; Function compile flags: /Ogspy
; File c:\users\apple\desktop\vlmcsd\src\ntservice.c
;	COMDAT OpenAndRemoveService
_TEXT	SEGMENT
status$ = 0
dwPreviousState$ = 48
schSCManager$ = 56
OpenAndRemoveService PROC				; COMDAT

; 127  : {

  00000	40 55		 push	 rbp
  00002	48 83 ec 40	 sub	 rsp, 64			; 00000040H
  00006	48 8d 6c 24 20	 lea	 rbp, QWORD PTR [rsp+32]
  0000b	48 89 5d 30	 mov	 QWORD PTR [rbp+48], rbx
  0000f	48 89 75 38	 mov	 QWORD PTR [rbp+56], rsi
  00013	48 89 7d 40	 mov	 QWORD PTR [rbp+64], rdi
  00017	4c 89 75 48	 mov	 QWORD PTR [rbp+72], r14

; 128  : 	SERVICE_STATUS status;
; 129  : 	uint_fast8_t i;
; 130  : 	SC_HANDLE installedService;
; 131  : 	uint_fast8_t result = 1;
; 132  : 	BOOL closeManager = FALSE;

  0001b	45 33 f6	 xor	 r14d, r14d
  0001e	48 8b f2	 mov	 rsi, rdx

; 133  : 
; 134  : 	// Allow NULL for both Arguments
; 135  : 	//两个参数都允许NULL
; 136  : 	if (!dwPreviousState) dwPreviousState = (DWORD*)alloca(sizeof(*dwPreviousState));

  00021	41 8d 46 10	 lea	 eax, QWORD PTR [r14+16]
  00025	48 8b d9	 mov	 rbx, rcx
  00028	48 85 c9	 test	 rcx, rcx
  0002b	75 0d		 jne	 SHORT $LN12@OpenAndRem
  0002d	8b 0c 24	 mov	 ecx, DWORD PTR [rsp]
  00030	48 2b e0	 sub	 rsp, rax
  00033	48 8d 5c 24 20	 lea	 rbx, QWORD PTR [rsp+32]
  00038	8b 0b		 mov	 ecx, DWORD PTR [rbx]
$LN12@OpenAndRem:

; 137  : 	if (!schSCManager)

  0003a	48 85 d2	 test	 rdx, rdx
  0003d	75 11		 jne	 SHORT $LN11@OpenAndRem

; 138  : 	{
; 139  : 		schSCManager = (SC_HANDLE*)alloca(sizeof(*schSCManager));

  0003f	8b 0c 24	 mov	 ecx, DWORD PTR [rsp]
  00042	48 2b e0	 sub	 rsp, rax
  00045	48 8d 74 24 20	 lea	 rsi, QWORD PTR [rsp+32]
  0004a	8b 06		 mov	 eax, DWORD PTR [rsi]

; 140  : 		closeManager = TRUE;

  0004c	44 8d 72 01	 lea	 r14d, QWORD PTR [rdx+1]
$LN11@OpenAndRem:

; 141  : 	}
; 142  : 
; 143  : 	*schSCManager = OpenSCManager(
; 144  : 		NULL,                    // local computer 本地计算机
; 145  : 		NULL,                    // ServicesActive database ServicesActive数据库
; 146  : 		SC_MANAGER_ALL_ACCESS);  // full access rights 完全访问权限

  00050	33 d2		 xor	 edx, edx
  00052	33 c9		 xor	 ecx, ecx
  00054	41 b8 3f 00 0f
	00		 mov	 r8d, 983103		; 000f003fH
  0005a	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_OpenSCManagerA
  00060	48 89 06	 mov	 QWORD PTR [rsi], rax

; 147  : 
; 148  : 	if (!*schSCManager) return 0;

  00063	48 85 c0	 test	 rax, rax
  00066	0f 84 a0 00 00
	00		 je	 $LN13@OpenAndRem
$LN10@OpenAndRem:

; 149  : 
; 150  : 	if (!((installedService = OpenService(*schSCManager, NT_SERVICE_NAME, SERVICE_ALL_ACCESS))))

  0006c	48 8d 15 00 00
	00 00		 lea	 rdx, OFFSET FLAT:??_C@_03HLHKOPNL@KMS?$AA@
  00073	41 b8 ff 01 0f
	00		 mov	 r8d, 983551		; 000f01ffH
  00079	48 8b c8	 mov	 rcx, rax
  0007c	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_OpenServiceA
  00082	48 8b f8	 mov	 rdi, rax
  00085	48 85 c0	 test	 rax, rax
  00088	75 04		 jne	 SHORT $LN9@OpenAndRem

; 151  : 	{
; 152  : 		result = 2;

  0008a	b3 02		 mov	 bl, 2

; 153  : 	}
; 154  : 	else

  0008c	eb 6e		 jmp	 SHORT $LN8@OpenAndRem
$LN9@OpenAndRem:

; 155  : 	{
; 156  : 		*dwPreviousState = SERVICE_STOPPED;
; 157  : 		if (QueryServiceStatus(installedService, &status)) *dwPreviousState = status.dwCurrentState;

  0008e	48 8d 55 00	 lea	 rdx, QWORD PTR status$[rbp]
  00092	48 8b c8	 mov	 rcx, rax
  00095	c7 03 01 00 00
	00		 mov	 DWORD PTR [rbx], 1
  0009b	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_QueryServiceStatus
  000a1	85 c0		 test	 eax, eax
  000a3	74 05		 je	 SHORT $LN7@OpenAndRem
  000a5	8b 45 04	 mov	 eax, DWORD PTR status$[rbp+4]
  000a8	89 03		 mov	 DWORD PTR [rbx], eax
$LN7@OpenAndRem:

; 158  : 
; 159  : 		ControlService(installedService, SERVICE_CONTROL_STOP, &status);

  000aa	4c 8d 45 00	 lea	 r8, QWORD PTR status$[rbp]
  000ae	ba 01 00 00 00	 mov	 edx, 1
  000b3	48 8b cf	 mov	 rcx, rdi
  000b6	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_ControlService

; 160  : 
; 161  : 		for (i = 0; i < 10; i++)

  000bc	32 db		 xor	 bl, bl
$LL6@OpenAndRem:

; 162  : 		{
; 163  : 			QueryServiceStatus(installedService, &status);

  000be	48 8d 55 00	 lea	 rdx, QWORD PTR status$[rbp]
  000c2	48 8b cf	 mov	 rcx, rdi
  000c5	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_QueryServiceStatus

; 164  : 			// Give it 100 ms after it reported SERVICE_STOPPED. Subsequent CreateService will fail otherwise
; 165  : 			//在报告SERVICE_STOPPED 100毫秒后给它。 否则，后续的CreateService将失败
; 166  : 			Sleep(100);

  000cb	b9 64 00 00 00	 mov	 ecx, 100		; 00000064H
  000d0	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_Sleep

; 167  : 			if (status.dwCurrentState == SERVICE_STOPPED) break;

  000d6	83 7d 04 01	 cmp	 DWORD PTR status$[rbp+4], 1
  000da	74 07		 je	 SHORT $LN16@OpenAndRem

; 160  : 
; 161  : 		for (i = 0; i < 10; i++)

  000dc	fe c3		 inc	 bl
  000de	80 fb 0a	 cmp	 bl, 10
  000e1	72 db		 jb	 SHORT $LL6@OpenAndRem
$LN16@OpenAndRem:

; 168  : 		}
; 169  : 
; 170  : 		if (!DeleteService(installedService)) result = 0;

  000e3	48 8b cf	 mov	 rcx, rdi
  000e6	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_DeleteService

; 171  : 		CloseServiceHandle(installedService);

  000ec	48 8b cf	 mov	 rcx, rdi
  000ef	f7 d8		 neg	 eax
  000f1	1a db		 sbb	 bl, bl
  000f3	80 e3 01	 and	 bl, 1
  000f6	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_CloseServiceHandle
$LN8@OpenAndRem:

; 172  : 	}
; 173  : 
; 174  : 	if (closeManager) CloseServiceHandle(*schSCManager);

  000fc	45 85 f6	 test	 r14d, r14d
  000ff	74 09		 je	 SHORT $LN1@OpenAndRem
  00101	48 8b 0e	 mov	 rcx, QWORD PTR [rsi]
  00104	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_CloseServiceHandle
$LN1@OpenAndRem:

; 175  : 	return result;

  0010a	8a c3		 mov	 al, bl
$LN13@OpenAndRem:

; 176  : }

  0010c	48 8b 5d 30	 mov	 rbx, QWORD PTR [rbp+48]
  00110	48 8b 75 38	 mov	 rsi, QWORD PTR [rbp+56]
  00114	48 8b 7d 40	 mov	 rdi, QWORD PTR [rbp+64]
  00118	4c 8b 75 48	 mov	 r14, QWORD PTR [rbp+72]
  0011c	48 8d 65 20	 lea	 rsp, QWORD PTR [rbp+32]
  00120	5d		 pop	 rbp
  00121	c3		 ret	 0
OpenAndRemoveService ENDP
_TEXT	ENDS
; Function compile flags: /Ogspy
; File c:\users\apple\desktop\vlmcsd\src\ntservice.c
;	COMDAT ServiceInstaller
_TEXT	SEGMENT
status$ = 112
szPath$ = 144
ServiceUser$ = 480
ServicePassword$ = 488
dwPreviousState$ = 496
schSCManager$ = 504
ServiceInstaller PROC					; COMDAT

; 181  : {

  00000	48 89 5c 24 08	 mov	 QWORD PTR [rsp+8], rbx
  00005	55		 push	 rbp
  00006	56		 push	 rsi
  00007	57		 push	 rdi
  00008	41 54		 push	 r12
  0000a	41 55		 push	 r13
  0000c	41 56		 push	 r14
  0000e	41 57		 push	 r15
  00010	48 8d ac 24 60
	ff ff ff	 lea	 rbp, QWORD PTR [rsp-160]
  00018	48 81 ec a0 01
	00 00		 sub	 rsp, 416		; 000001a0H
  0001f	4c 8b f1	 mov	 r14, rcx
  00022	4c 8b e2	 mov	 r12, rdx

; 182  : 	SC_HANDLE schSCManager; //服务控制管理程序维护的登记数据库的句柄，由系统函数OpenSCManager 返回
; 183  : 	SC_HANDLE schService;
; 184  : 	char szPath[MAX_PATH] = "\"";

  00025	b8 22 00 00 00	 mov	 eax, 34			; 00000022H
  0002a	48 8d 4d 92	 lea	 rcx, QWORD PTR szPath$[rbp-254]
  0002e	33 d2		 xor	 edx, edx
  00030	41 b8 02 01 00
	00		 mov	 r8d, 258		; 00000102H
  00036	66 89 45 90	 mov	 WORD PTR szPath$[rbp-256], ax
  0003a	e8 00 00 00 00	 call	 memset

; 185  : 	//GetModuleFileName获取模块文件名
; 186  : 	if (!GetModuleFileName(NULL, szPath + sizeof(char), MAX_PATH - 1))

  0003f	48 8d 55 91	 lea	 rdx, QWORD PTR szPath$[rbp-255]
  00043	41 b8 03 01 00
	00		 mov	 r8d, 259		; 00000103H
  00049	33 c9		 xor	 ecx, ecx
  0004b	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_GetModuleFileNameA
  00051	45 33 ff	 xor	 r15d, r15d
  00054	85 c0		 test	 eax, eax
  00056	75 19		 jne	 SHORT $LN29@ServiceIns

; 187  : 	{
; 188  : 		errorout("无法安装服务 (%d)\n", (uint32_t)GetLastError());

  00058	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_GetLastError
  0005e	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_0BD@FKPFFKIB@?N?$NO?$LH?$KI?$LA?$LC?W?$LA?$LH?$PO?N?q?5?$CI?$CFd?$CJ?6?$AA@
$LN62@ServiceIns:
  00065	8b d0		 mov	 edx, eax
  00067	e8 00 00 00 00	 call	 errorout

; 189  : 		return;

  0006c	e9 a5 03 00 00	 jmp	 $LN30@ServiceIns
$LN29@ServiceIns:

; 190  : 	}
; 191  : 
; 192  : 	strcat(szPath, "\"");

  00071	48 8d 4d 90	 lea	 rcx, QWORD PTR szPath$[rbp-256]
  00075	41 bd 01 00 00
	00		 mov	 r13d, 1
  0007b	49 2b cd	 sub	 rcx, r13
$LL57@ServiceIns:
  0007e	49 03 cd	 add	 rcx, r13
  00081	44 38 39	 cmp	 BYTE PTR [rcx], r15b
  00084	75 f8		 jne	 SHORT $LL57@ServiceIns

; 193  : 
; 194  : 	int i;
; 195  : 	for (i = 1; i < global_argc; i++)

  00086	44 39 2d 00 00
	00 00		 cmp	 DWORD PTR global_argc, r13d
  0008d	0f b7 05 00 00
	00 00		 movzx	 eax, WORD PTR ??_C@_01BJJEKLCA@?$CC?$AA@
  00094	41 8b dd	 mov	 ebx, r13d
  00097	66 89 01	 mov	 WORD PTR [rcx], ax
  0009a	0f 8e 3c 01 00
	00		 jle	 $LN26@ServiceIns
  000a0	4c 8b 05 00 00
	00 00		 mov	 r8, QWORD PTR global_argv
  000a7	bf 08 00 00 00	 mov	 edi, 8
$LL28@ServiceIns:

; 196  : 	{
; 197  : 		// Strip unneccessary parameters, especially the password
; 198  : 		//剥去不必要的参数，特别是密码
; 199  : 		if (!strcmp(global_argv[i], "-s")) continue;

  000ac	4a 8b 0c 07	 mov	 rcx, QWORD PTR [rdi+r8]
  000b0	8a 01		 mov	 al, BYTE PTR [rcx]
  000b2	3a 05 00 00 00
	00		 cmp	 al, BYTE PTR ??_C@_02DEDJNJGL@?9s?$AA@
  000b8	75 1a		 jne	 SHORT $LN56@ServiceIns
  000ba	8a 41 01	 mov	 al, BYTE PTR [rcx+1]
  000bd	3a 05 01 00 00
	00		 cmp	 al, BYTE PTR ??_C@_02DEDJNJGL@?9s?$AA@+1
  000c3	75 0f		 jne	 SHORT $LN56@ServiceIns
  000c5	8a 41 02	 mov	 al, BYTE PTR [rcx+2]
  000c8	3a 05 02 00 00
	00		 cmp	 al, BYTE PTR ??_C@_02DEDJNJGL@?9s?$AA@+2
  000ce	0f 84 f5 00 00
	00		 je	 $LN27@ServiceIns
$LN56@ServiceIns:

; 200  : 
; 201  : 		if (!strcmp(global_argv[i], "-W") ||
; 202  : 			!strcmp(global_argv[i], "-U"))

  000d4	8a 01		 mov	 al, BYTE PTR [rcx]
  000d6	3a 05 00 00 00
	00		 cmp	 al, BYTE PTR ??_C@_02MFNBDIMN@?9W?$AA@
  000dc	75 16		 jne	 SHORT $LN55@ServiceIns
  000de	8a 41 01	 mov	 al, BYTE PTR [rcx+1]
  000e1	3a 05 01 00 00
	00		 cmp	 al, BYTE PTR ??_C@_02MFNBDIMN@?9W?$AA@+1
  000e7	75 0b		 jne	 SHORT $LN55@ServiceIns
  000e9	8a 41 02	 mov	 al, BYTE PTR [rcx+2]
  000ec	3a 05 02 00 00
	00		 cmp	 al, BYTE PTR ??_C@_02MFNBDIMN@?9W?$AA@+2
  000f2	74 20		 je	 SHORT $LN23@ServiceIns
$LN55@ServiceIns:
  000f4	8a 01		 mov	 al, BYTE PTR [rcx]
  000f6	3a 05 00 00 00
	00		 cmp	 al, BYTE PTR ??_C@_02PHOHFKEP@?9U?$AA@
  000fc	75 22		 jne	 SHORT $LN54@ServiceIns
  000fe	8a 41 01	 mov	 al, BYTE PTR [rcx+1]
  00101	3a 05 01 00 00
	00		 cmp	 al, BYTE PTR ??_C@_02PHOHFKEP@?9U?$AA@+1
  00107	75 17		 jne	 SHORT $LN54@ServiceIns
  00109	8a 41 02	 mov	 al, BYTE PTR [rcx+2]
  0010c	3a 05 02 00 00
	00		 cmp	 al, BYTE PTR ??_C@_02PHOHFKEP@?9U?$AA@+2
  00112	75 0c		 jne	 SHORT $LN54@ServiceIns
$LN23@ServiceIns:

; 203  : 		{
; 204  : 			i++;

  00114	41 03 dd	 add	 ebx, r13d
  00117	48 83 c7 08	 add	 rdi, 8
  0011b	e9 a9 00 00 00	 jmp	 $LN27@ServiceIns
$LN54@ServiceIns:

; 205  : 			continue;
; 206  : 		}
; 207  : 
; 208  : 		strcat(szPath, " ");

  00120	48 8d 4d 90	 lea	 rcx, QWORD PTR szPath$[rbp-256]
  00124	49 2b cd	 sub	 rcx, r13
$LL53@ServiceIns:
  00127	49 03 cd	 add	 rcx, r13
  0012a	44 38 39	 cmp	 BYTE PTR [rcx], r15b
  0012d	75 f8		 jne	 SHORT $LL53@ServiceIns
  0012f	0f b7 05 00 00
	00 00		 movzx	 eax, WORD PTR ??_C@_01CLKCMJKC@?5?$AA@

; 209  : 
; 210  : 		if (strchr(global_argv[i], ' '))

  00136	ba 20 00 00 00	 mov	 edx, 32			; 00000020H
  0013b	66 89 01	 mov	 WORD PTR [rcx], ax
  0013e	4a 8b 0c 07	 mov	 rcx, QWORD PTR [rdi+r8]
  00142	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_strchr

; 211  : 		{
; 212  : 			strcat(szPath, "\"");

  00148	48 8d 4d 90	 lea	 rcx, QWORD PTR szPath$[rbp-256]
  0014c	49 2b cd	 sub	 rcx, r13
  0014f	48 85 c0	 test	 rax, rax
  00152	74 52		 je	 SHORT $LL47@ServiceIns
$LL52@ServiceIns:
  00154	49 03 cd	 add	 rcx, r13
  00157	44 38 39	 cmp	 BYTE PTR [rcx], r15b
  0015a	75 f8		 jne	 SHORT $LL52@ServiceIns
  0015c	0f b7 05 00 00
	00 00		 movzx	 eax, WORD PTR ??_C@_01BJJEKLCA@?$CC?$AA@

; 213  : 			strcat(szPath, global_argv[i]);

  00163	48 8d 55 90	 lea	 rdx, QWORD PTR szPath$[rbp-256]
  00167	66 89 01	 mov	 WORD PTR [rcx], ax
  0016a	49 2b d5	 sub	 rdx, r13
$LL50@ServiceIns:
  0016d	49 03 d5	 add	 rdx, r13
  00170	44 38 3a	 cmp	 BYTE PTR [rdx], r15b
  00173	75 f8		 jne	 SHORT $LL50@ServiceIns
  00175	4c 8b 05 00 00
	00 00		 mov	 r8, QWORD PTR global_argv
  0017c	45 33 c9	 xor	 r9d, r9d
  0017f	4e 8b 14 07	 mov	 r10, QWORD PTR [rdi+r8]
$LL51@ServiceIns:
  00183	43 8a 0c 0a	 mov	 cl, BYTE PTR [r10+r9]
  00187	42 88 0c 0a	 mov	 BYTE PTR [rdx+r9], cl
  0018b	49 ff c1	 inc	 r9
  0018e	84 c9		 test	 cl, cl
  00190	75 f1		 jne	 SHORT $LL51@ServiceIns

; 214  : 			strcat(szPath, "\"");

  00192	48 8d 4d 90	 lea	 rcx, QWORD PTR szPath$[rbp-256]
  00196	49 2b cd	 sub	 rcx, r13
$LL49@ServiceIns:
  00199	49 03 cd	 add	 rcx, r13
  0019c	44 38 39	 cmp	 BYTE PTR [rcx], r15b
  0019f	75 f8		 jne	 SHORT $LL49@ServiceIns
  001a1	66 89 01	 mov	 WORD PTR [rcx], ax

; 215  : 		}
; 216  : 		else

  001a4	eb 23		 jmp	 SHORT $LN27@ServiceIns
$LL47@ServiceIns:

; 217  : 			strcat(szPath, global_argv[i]);

  001a6	49 03 cd	 add	 rcx, r13
  001a9	44 38 39	 cmp	 BYTE PTR [rcx], r15b
  001ac	75 f8		 jne	 SHORT $LL47@ServiceIns
  001ae	4c 8b 05 00 00
	00 00		 mov	 r8, QWORD PTR global_argv
  001b5	33 d2		 xor	 edx, edx
  001b7	4e 8b 0c 07	 mov	 r9, QWORD PTR [rdi+r8]
$LL48@ServiceIns:
  001bb	41 8a 04 11	 mov	 al, BYTE PTR [r9+rdx]
  001bf	88 04 11	 mov	 BYTE PTR [rcx+rdx], al
  001c2	48 ff c2	 inc	 rdx
  001c5	84 c0		 test	 al, al
  001c7	75 f2		 jne	 SHORT $LL48@ServiceIns
$LN27@ServiceIns:

; 193  : 
; 194  : 	int i;
; 195  : 	for (i = 1; i < global_argc; i++)

  001c9	41 03 dd	 add	 ebx, r13d
  001cc	48 83 c7 08	 add	 rdi, 8
  001d0	3b 1d 00 00 00
	00		 cmp	 ebx, DWORD PTR global_argc
  001d6	0f 8c d0 fe ff
	ff		 jl	 $LL28@ServiceIns
$LN26@ServiceIns:

; 218  : 	}
; 219  : 
; 220  : 	// Get a handle to the SCM database.
; 221  : 	//获取SCM数据库的句柄。
; 222  : 
; 223  : 	SERVICE_STATUS status;
; 224  : 	DWORD dwPreviousState;
; 225  : 
; 226  : 	if (!OpenAndRemoveService(&dwPreviousState, &schSCManager))

  001dc	48 8d 95 f8 00
	00 00		 lea	 rdx, QWORD PTR schSCManager$[rbp-256]
  001e3	48 8d 8d f0 00
	00 00		 lea	 rcx, QWORD PTR dwPreviousState$[rbp-256]
  001ea	e8 00 00 00 00	 call	 OpenAndRemoveService
  001ef	84 c0		 test	 al, al
  001f1	75 12		 jne	 SHORT $LN20@ServiceIns

; 227  : 	{
; 228  : 		errorout("服务删除失败 (%d)\n", (uint32_t)GetLastError());

  001f3	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_GetLastError
  001f9	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_0BD@KBOGNFMA@?$LH?$PO?N?q?I?$LO?$LD?$PN?J?$KH?$LA?$NM?5?$CI?$CFd?$CJ?6?$AA@

; 229  : 		return;

  00200	e9 60 fe ff ff	 jmp	 $LN62@ServiceIns
$LN20@ServiceIns:

; 230  : 	}
; 231  : 
; 232  : 	char *tempUser = NULL;
; 233  : 
; 234  : 	if (ServiceUser)

  00205	48 83 ce ff	 or	 rsi, -1
  00209	49 8b df	 mov	 rbx, r15
  0020c	4d 85 f6	 test	 r14, r14
  0020f	0f 84 97 00 00
	00		 je	 $LN16@ServiceIns

; 235  : 	{
; 236  : 		// Shortcuts for some well known users
; 237  : 		if (!strcasecmp(ServiceUser, "/l")) ServiceUser = "NT AUTHORITY\\LocalService";

  00215	48 8d 15 00 00
	00 00		 lea	 rdx, OFFSET FLAT:??_C@_02PKOHADJL@?1l?$AA@
  0021c	49 8b ce	 mov	 rcx, r14
  0021f	ff 15 00 00 00
	00		 call	 QWORD PTR __imp__stricmp
  00225	48 8d 3d 00 00
	00 00		 lea	 rdi, OFFSET FLAT:??_C@_0BK@PHAGCFFB@NT?5AUTHORITY?2LocalService?$AA@

; 238  : 		if (!strcasecmp(ServiceUser, "/n")) ServiceUser = "NT AUTHORITY\\NetworkService";

  0022c	48 8d 15 00 00
	00 00		 lea	 rdx, OFFSET FLAT:??_C@_02MINBGBBJ@?1n?$AA@
  00233	85 c0		 test	 eax, eax
  00235	49 0f 45 fe	 cmovne	 rdi, r14
  00239	48 8b cf	 mov	 rcx, rdi
  0023c	ff 15 00 00 00
	00		 call	 QWORD PTR __imp__stricmp
  00242	4c 8d 35 00 00
	00 00		 lea	 r14, OFFSET FLAT:??_C@_0BM@PDMNECKP@NT?5AUTHORITY?2NetworkService?$AA@

; 239  : 
; 240  : 		// Allow Local Users without .\ , e.g. "johndoe" instead of ".\johndoe"
; 241  : 		//允许没有。\的本地用户，例如 “johndoe”而不是“。\ johndoe”
; 242  : 		if (!strchr(ServiceUser, '\\'))

  00249	8d 56 5d	 lea	 edx, QWORD PTR [rsi+93]
  0024c	85 c0		 test	 eax, eax
  0024e	4c 0f 45 f7	 cmovne	 r14, rdi
  00252	49 8b ce	 mov	 rcx, r14
  00255	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_strchr
  0025b	48 85 c0	 test	 rax, rax
  0025e	75 4c		 jne	 SHORT $LN16@ServiceIns

; 243  : 		{
; 244  : 			tempUser = (char*)vlmcsd_malloc(strlen(ServiceUser) + 3);

  00260	48 8b ce	 mov	 rcx, rsi
$LL46@ServiceIns:
  00263	48 ff c1	 inc	 rcx
  00266	45 38 3c 0e	 cmp	 BYTE PTR [r14+rcx], r15b
  0026a	75 f7		 jne	 SHORT $LL46@ServiceIns
  0026c	48 83 c1 03	 add	 rcx, 3
  00270	e8 00 00 00 00	 call	 vlmcsd_malloc

; 245  : 			strcpy(tempUser, ".\\");

  00275	0f b7 0d 00 00
	00 00		 movzx	 ecx, WORD PTR ??_C@_02CEGDFPFP@?4?2?$AA@
  0027c	66 89 08	 mov	 WORD PTR [rax], cx
  0027f	8a 0d 02 00 00
	00		 mov	 cl, BYTE PTR ??_C@_02CEGDFPFP@?4?2?$AA@+2
  00285	48 8b d8	 mov	 rbx, rax
  00288	88 48 02	 mov	 BYTE PTR [rax+2], cl

; 246  : 			strcat(tempUser, ServiceUser);

  0028b	48 8b c8	 mov	 rcx, rax
  0028e	49 2b cd	 sub	 rcx, r13
$LL44@ServiceIns:
  00291	49 03 cd	 add	 rcx, r13
  00294	44 38 39	 cmp	 BYTE PTR [rcx], r15b
  00297	75 f8		 jne	 SHORT $LL44@ServiceIns
  00299	33 d2		 xor	 edx, edx
$LL45@ServiceIns:
  0029b	41 8a 04 16	 mov	 al, BYTE PTR [r14+rdx]
  0029f	88 04 11	 mov	 BYTE PTR [rcx+rdx], al
  002a2	48 ff c2	 inc	 rdx
  002a5	84 c0		 test	 al, al
  002a7	75 f2		 jne	 SHORT $LL45@ServiceIns

; 247  : 			ServiceUser = tempUser;

  002a9	4c 8b f3	 mov	 r14, rbx
$LN16@ServiceIns:

; 248  : 		}
; 249  : 	}
; 250  : 
; 251  : 	schService = CreateService(
; 252  : 		schSCManager,				//  //服务控制管理程序维护的登记数据库的句柄，由系统函数OpenSCManager 返回
; 253  : 		NT_SERVICE_NAME,			// name of service 服务名称
; 254  : 		NT_SERVICE_DISPLAY_NAME,	// service name to display 显示服务名称
; 255  : 		SERVICE_ALL_ACCESS,			// desired access
; 256  : 		SERVICE_WIN32_OWN_PROCESS,	// service type 服务类型
; 257  : 		SERVICE_AUTO_START,			// start type 启动类型
; 258  : 		SERVICE_ERROR_NORMAL,		// error control type 错误控制类型
; 259  : 		szPath,						// path to service's binary 服务二进制路径
; 260  : 		NULL,						// no load ordering group 空载顺序组
; 261  : 		NULL,						// no tag identifier 没有标签标识符
; 262  : 		"tcpip\0",			        // depends on TCP/IP 取决于TCP/IP
; 263  : 		ServiceUser,				// LocalSystem account LocalSystem帐户
; 264  : 		ServicePassword);			// no password 没有密码

  002ac	4c 89 64 24 60	 mov	 QWORD PTR [rsp+96], r12
  002b1	4c 89 74 24 58	 mov	 QWORD PTR [rsp+88], r14
  002b6	48 8d 05 00 00
	00 00		 lea	 rax, OFFSET FLAT:??_C@_06BPNJJJFL@tcpip?$AA?$AA@
  002bd	48 89 44 24 50	 mov	 QWORD PTR [rsp+80], rax
  002c2	4c 89 7c 24 48	 mov	 QWORD PTR [rsp+72], r15
  002c7	4c 89 7c 24 40	 mov	 QWORD PTR [rsp+64], r15
  002cc	4c 8b bd f8 00
	00 00		 mov	 r15, QWORD PTR schSCManager$[rbp-256]
  002d3	48 8d 45 90	 lea	 rax, QWORD PTR szPath$[rbp-256]
  002d7	4c 8d 05 00 00
	00 00		 lea	 r8, OFFSET FLAT:??_C@_0BE@PCJAAINM@KeyManagementServer?$AA@
  002de	48 89 44 24 38	 mov	 QWORD PTR [rsp+56], rax
  002e3	44 89 6c 24 30	 mov	 DWORD PTR [rsp+48], r13d
  002e8	48 8d 15 00 00
	00 00		 lea	 rdx, OFFSET FLAT:??_C@_03HLHKOPNL@KMS?$AA@
  002ef	49 8b cf	 mov	 rcx, r15
  002f2	41 b9 ff 01 0f
	00		 mov	 r9d, 983551		; 000f01ffH
  002f8	c7 44 24 28 02
	00 00 00	 mov	 DWORD PTR [rsp+40], 2
  00300	c7 44 24 20 10
	00 00 00	 mov	 DWORD PTR [rsp+32], 16
  00308	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_CreateServiceA
  0030e	4c 8b f0	 mov	 r14, rax
$LL43@ServiceIns:

; 265  : 
; 266  : #	if __clang__ && (__CYGWIN__ || __MINGW64__ )
; 267  : 	// Workaround for clang not understanding some GCC asm syntax used in <w32api/psdk_inc/intrin-impl.h>
; 268  : 	ZeroMemory((char*)ServicePassword, strlen(ServicePassword));
; 269  : #	else
; 270  : 	SecureZeroMemory((char*)ServicePassword, strlen(ServicePassword));

  00311	48 ff c6	 inc	 rsi
  00314	41 80 3c 34 00	 cmp	 BYTE PTR [r12+rsi], 0
  00319	75 f6		 jne	 SHORT $LL43@ServiceIns
  0031b	33 c0		 xor	 eax, eax
  0031d	48 8b ce	 mov	 rcx, rsi
  00320	49 8b fc	 mov	 rdi, r12
  00323	f3 aa		 rep stosb

; 271  : #	endif
; 272  : 	if (tempUser) free(tempUser);

  00325	48 85 db	 test	 rbx, rbx
  00328	74 09		 je	 SHORT $LN15@ServiceIns
  0032a	48 8b cb	 mov	 rcx, rbx
  0032d	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_free
$LN15@ServiceIns:

; 273  : 
; 274  : 	if (schService == NULL)

  00333	4d 85 f6	 test	 r14, r14
  00336	75 19		 jne	 SHORT $LN14@ServiceIns

; 275  : 	{
; 276  : 		errorout("创建服务失败 (%u)\n", (uint32_t)GetLastError());

  00338	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_GetLastError
  0033e	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_0BD@DCFFOBGC@?$LE?$LE?$LN?$KI?$LH?$PO?N?q?J?$KH?$LA?$NM?5?$CI?$CFu?$CJ?6?$AA@
  00345	8b d0		 mov	 edx, eax
  00347	e8 00 00 00 00	 call	 errorout

; 277  : 		CloseServiceHandle(schSCManager);
; 278  : 		return;

  0034c	e9 bc 00 00 00	 jmp	 $LN59@ServiceIns
$LN14@ServiceIns:

; 279  : 	}
; 280  : 	else
; 281  : 	{
; 282  : 		errorout("服务安装成功\n");

  00351	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_0O@IJHOBBJB@?$LH?$PO?N?q?$LA?$LC?W?$LA?$LD?I?$LJ?$KG?6?$AA@
  00358	e8 00 00 00 00	 call	 errorout

; 283  : 
; 284  : 		if (dwPreviousState == SERVICE_RUNNING)

  0035d	83 bd f0 00 00
	00 04		 cmp	 DWORD PTR dwPreviousState$[rbp-256], 4
  00364	0f 85 9a 00 00
	00		 jne	 $LN1@ServiceIns

; 285  : 		{
; 286  : 			printf("重新启动 " NT_SERVICE_NAME " 服务 => ");

  0036a	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_0BG@MFFHEMO@?V?X?P?B?F?t?$LG?$KP?5KMS?5?$LH?$PO?N?q?5?$DN?$DO?5?$AA@
  00371	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_printf

; 287  : 			status.dwCurrentState = SERVICE_STOPPED;
; 288  : 
; 289  : 			if (StartService(schService, 0, NULL))

  00377	45 33 c0	 xor	 r8d, r8d
  0037a	33 d2		 xor	 edx, edx
  0037c	49 8b ce	 mov	 rcx, r14
  0037f	44 89 6c 24 74	 mov	 DWORD PTR status$[rsp+4], r13d
  00384	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_StartServiceA
  0038a	85 c0		 test	 eax, eax
  0038c	74 62		 je	 SHORT $LN11@ServiceIns

; 290  : 			{
; 291  : 				for (i = 0; i < 10; i++)

  0038e	33 ff		 xor	 edi, edi
$LL10@ServiceIns:

; 292  : 				{
; 293  : 					if (!QueryServiceStatus(schService, &status) || status.dwCurrentState != SERVICE_START_PENDING) break;

  00390	48 8d 54 24 70	 lea	 rdx, QWORD PTR status$[rsp]
  00395	49 8b ce	 mov	 rcx, r14
  00398	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_QueryServiceStatus
  0039e	85 c0		 test	 eax, eax
  003a0	74 1a		 je	 SHORT $LN58@ServiceIns
  003a2	8b 44 24 74	 mov	 eax, DWORD PTR status$[rsp+4]
  003a6	83 f8 02	 cmp	 eax, 2
  003a9	75 15		 jne	 SHORT $LN36@ServiceIns

; 294  : 					Sleep(100);

  003ab	8d 48 62	 lea	 ecx, QWORD PTR [rax+98]
  003ae	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_Sleep
  003b4	41 03 fd	 add	 edi, r13d
  003b7	83 ff 0a	 cmp	 edi, 10
  003ba	7c d4		 jl	 SHORT $LL10@ServiceIns
$LN58@ServiceIns:

; 290  : 			{
; 291  : 				for (i = 0; i < 10; i++)

  003bc	8b 44 24 74	 mov	 eax, DWORD PTR status$[rsp+4]
$LN36@ServiceIns:

; 295  : 				}
; 296  : 
; 297  : 				if (status.dwCurrentState == SERVICE_RUNNING)

  003c0	83 f8 04	 cmp	 eax, 4
  003c3	75 09		 jne	 SHORT $LN5@ServiceIns

; 298  : 					printf("成功\n");

  003c5	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_05HBAGHNGF@?$LD?I?$LJ?$KG?6?$AA@
  003cc	eb 0c		 jmp	 SHORT $LN60@ServiceIns
$LN5@ServiceIns:

; 299  : 				else if (status.dwCurrentState == SERVICE_START_PENDING)

  003ce	83 f8 02	 cmp	 eax, 2
  003d1	75 0f		 jne	 SHORT $LN3@ServiceIns

; 300  : 					printf("Not ready within a second\n");

  003d3	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_0BL@MMELEJAD@Not?5ready?5within?5a?5second?6?$AA@
$LN60@ServiceIns:
  003da	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_printf

; 301  : 				else

  003e0	eb 22		 jmp	 SHORT $LN1@ServiceIns
$LN3@ServiceIns:

; 302  : 					errorout("Error\n");

  003e2	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_06HPIHNGNL@Error?6?$AA@
  003e9	e8 00 00 00 00	 call	 errorout

; 303  : 			}
; 304  : 			else

  003ee	eb 14		 jmp	 SHORT $LN1@ServiceIns
$LN11@ServiceIns:

; 305  : 				errorout("Error %u\n", (uint32_t)GetLastError());

  003f0	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_GetLastError
  003f6	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_09JBCKIECM@Error?5?$CFu?6?$AA@
  003fd	8b d0		 mov	 edx, eax
  003ff	e8 00 00 00 00	 call	 errorout
$LN1@ServiceIns:

; 306  : 		}
; 307  : 	}
; 308  : 
; 309  : 	CloseServiceHandle(schService);

  00404	49 8b ce	 mov	 rcx, r14
  00407	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_CloseServiceHandle
$LN59@ServiceIns:

; 310  : 	CloseServiceHandle(schSCManager);

  0040d	49 8b cf	 mov	 rcx, r15
  00410	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_CloseServiceHandle
$LN30@ServiceIns:

; 311  : }

  00416	48 8b 9c 24 e0
	01 00 00	 mov	 rbx, QWORD PTR [rsp+480]
  0041e	48 81 c4 a0 01
	00 00		 add	 rsp, 416		; 000001a0H
  00425	41 5f		 pop	 r15
  00427	41 5e		 pop	 r14
  00429	41 5d		 pop	 r13
  0042b	41 5c		 pop	 r12
  0042d	5f		 pop	 rdi
  0042e	5e		 pop	 rsi
  0042f	5d		 pop	 rbp
  00430	c3		 ret	 0
ServiceInstaller ENDP
_TEXT	ENDS
; Function compile flags: /Ogspy
; File c:\users\apple\desktop\vlmcsd\src\ntservice.c
;	COMDAT NtServiceInstallation
_TEXT	SEGMENT
installService$dead$ = 48
ServiceUser$dead$ = 56
ServicePassword$dead$ = 64
NtServiceInstallation PROC				; COMDAT

; 314  : {

$LN13:
  00000	48 83 ec 28	 sub	 rsp, 40			; 00000028H

; 315  : 	if (IsNTService) return 0;

  00004	80 3d 00 00 00
	00 00		 cmp	 BYTE PTR IsNTService, 0
  0000b	75 1d		 jne	 SHORT $LN4@NtServiceI

; 316  : 
; 317  : 	if (installService == 1) // Install

  0000d	8a 05 00 00 00
	00		 mov	 al, BYTE PTR installService
  00013	3c 01		 cmp	 al, 1
  00015	75 1a		 jne	 SHORT $LN7@NtServiceI

; 318  : 	{
; 319  : 		ServiceInstaller(ServiceUser, ServicePassword);

  00017	48 8b 15 00 00
	00 00		 mov	 rdx, QWORD PTR ServicePassword
  0001e	48 8b 0d 00 00
	00 00		 mov	 rcx, QWORD PTR ServiceUser
  00025	e8 00 00 00 00	 call	 ServiceInstaller
$LN4@NtServiceI:

; 336  : 		}
; 337  : 	}
; 338  : 
; 339  : 	// Do nothing
; 340  : 
; 341  : 	return(0);

  0002a	33 c0		 xor	 eax, eax
$LN9@NtServiceI:

; 342  : }

  0002c	48 83 c4 28	 add	 rsp, 40			; 00000028H
  00030	c3		 ret	 0
$LN7@NtServiceI:

; 320  : 		return(0);
; 321  : 	}
; 322  : 
; 323  : 	if (installService == 2) // Remove

  00031	3c 02		 cmp	 al, 2
  00033	75 f5		 jne	 SHORT $LN4@NtServiceI

; 324  : 	{
; 325  : 		switch (OpenAndRemoveService(NULL, NULL))

  00035	33 d2		 xor	 edx, edx
  00037	33 c9		 xor	 ecx, ecx
  00039	e8 00 00 00 00	 call	 OpenAndRemoveService
  0003e	0f b6 d0	 movzx	 edx, al
  00041	84 c0		 test	 al, al
  00043	74 23		 je	 SHORT $LN3@NtServiceI
  00045	ff ca		 dec	 edx

; 333  : 		default:
; 334  : 			errorout("服务 %s不存在.\n", NT_SERVICE_NAME);

  00047	48 8d 15 00 00
	00 00		 lea	 rdx, OFFSET FLAT:??_C@_03HLHKOPNL@KMS?$AA@
  0004e	74 09		 je	 SHORT $LN2@NtServiceI
  00050	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_0BA@NOKEGPBL@?$LH?$PO?N?q?5?$CFs?$LC?$LL?$LE?f?T?Z?4?6?$AA@

; 335  : 			return(!0);

  00057	eb 1d		 jmp	 SHORT $LN11@NtServiceI
$LN2@NtServiceI:

; 330  : 		case 1:
; 331  : 			printf("服务 %s 成功移除.\n", NT_SERVICE_NAME);

  00059	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_0BD@DBLMEHIF@?$LH?$PO?N?q?5?$CFs?5?$LD?I?$LJ?$KG?R?F?$LD?$PN?4?6?$AA@
  00060	ff 15 00 00 00
	00		 call	 QWORD PTR __imp_printf

; 332  : 			return(0);

  00066	eb c2		 jmp	 SHORT $LN4@NtServiceI
$LN3@NtServiceI:

; 326  : 		{
; 327  : 		case 0:
; 328  : 			errorout("错误 删除服务. %s\n", NT_SERVICE_NAME);

  00068	48 8d 15 00 00
	00 00		 lea	 rdx, OFFSET FLAT:??_C@_03HLHKOPNL@KMS?$AA@
  0006f	48 8d 0d 00 00
	00 00		 lea	 rcx, OFFSET FLAT:??_C@_0BD@HFJNIJEE@?$LE?m?N?s?5?I?$LO?$LD?$PN?$LH?$PO?N?q?4?5?$CFs?6?$AA@
$LN11@NtServiceI:
  00076	e8 00 00 00 00	 call	 errorout

; 329  : 			return(!0);

  0007b	b8 01 00 00 00	 mov	 eax, 1
  00080	eb aa		 jmp	 SHORT $LN9@NtServiceI
NtServiceInstallation ENDP
_TEXT	ENDS
END
